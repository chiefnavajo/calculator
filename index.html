<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FRP STORE SOLUTIONS - PV Installationskosten-Rechner</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    body{font-family:'Inter',sans-serif}
    body::-webkit-scrollbar{width:8px}
    body::-webkit-scrollbar-track{background:#f1f5f9}
    body::-webkit-scrollbar-thumb{background-color:#cbd5e1;border-radius:4px}
    .num{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="bg-slate-100 p-6 flex items-center justify-center min-h-screen">
  <div class="bg-white rounded-2xl shadow-xl p-8 max-w-4xl w-full mx-auto">
    <header>
      <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-6">FRP STORE SOLUTIONS - PV Installationskosten-Rechner</h1>
      <p class="text-center text-gray-600 mb-8">Geben Sie die Details Ihres Projekts ein, um eine umfassende Kostenaufstellung und den endgültigen Kundenpreis zu erhalten.</p>
    </header>

    <form id="calculatorForm" class="space-y-6">
      <!-- Panels Section -->
      <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16.5 12a4.5 4.5 0 11-9 0 4.5 4.5 0 019 0z"/></svg>
          Module
        </h2>
        <div class="grid md:grid-cols-4 gap-4">
          <div>
            <label for="panelModel" class="block text-sm font-medium text-gray-700">Modell</label>
            <select id="panelModel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2">
              <option value="435" data-price="46.99">Trina TSM-435NEG9RC.27 (435W, Outlet) - 46,99 €</option>
              <option value="440" data-price="52.98">Trina TSM-440NEG9R.25 (440W, Full Black Outlet) - 52,98 €</option>
              <option value="440" data-price="51.29">Trina TSM-440NEG9RC.27 (440W, N-Typ, Outlet) - 51,29 €</option>
              <option value="445" data-price="56.98">Trina TSM-445NEG9R.25 (445W, Full Black Outlet) - 56,98 €</option>
              <option value="445" data-price="49.99">Trina TSM-445NEG9R.28 (445W, Regulär) - 49,99 €</option>
              <option value="450" data-price="47.98">Trina TSM-450NEG9R.28 (450W, Regulär) - 47,98 €</option>
              <option value="450" data-price="60.99">Trina TSM-450NEG9R.25 (450W, Full Black Regulär) - 60,99 €</option>
              <option value="455" data-price="55.31">Trina TSM-455NEG9R.28 (455W, Regulär) - 55,31 €</option>
            </select>
          </div>
          <div>
            <label for="panelCount" class="block text-sm font-medium text-gray-700">Anzahl</label>
            <input type="number" id="panelCount" value="12" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label for="panelPrice" class="block text-sm font-medium text-gray-700">Kosten pro Einheit (€)</label>
            <input type="number" id="panelPrice" value="46.99" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label for="panelRowTotal" class="block text-sm font-medium text-gray-700">Gesamtkosten (€)</label>
            <input type="text" id="panelRowTotal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 font-bold text-right num" value="0.00" readonly />
          </div>
        </div>
        <div class="mt-4 grid md:grid-cols-4 gap-4">
          <div>
            <label for="panelShipmentType" class="block text-sm font-medium text-gray-700">Art der Sendung</label>
            <select id="panelShipmentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
              <option value="package">Paket</option>
              <option value="pallet">Europalette</option>
            </select>
          </div>
          <div>
            <label for="panelTransportCount" class="block text-sm font-medium text-gray-700">Menge (Transport)</label>
            <input type="number" id="panelTransportCount" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label for="panelTransportPrice" class="block text-sm font-medium text-gray-700">Preis/Einheit (€)</label>
            <input type="number" id="panelTransportPrice" value="0" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Transport Gesamt (€)</label>
            <input type="text" id="panelTransportTotalDisplay" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 text-right num" readonly />
          </div>
        </div>
        <div class="mt-4 pt-4 border-t-2 border-slate-300 grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-3 text-right font-bold text-gray-700 text-lg pr-2">Zwischensumme Module</div>
            <div>
                <input type="text" id="subtotalPanels" class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-slate-200 font-bold text-right num" value="0.00" readonly />
            </div>
        </div>
      </section>

      <!-- Inverter Section -->
      <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M4.929 12a7 7 0 1114 0c0 1.573-.393 3.09-1.144 4.41L17.7 17.7a7 7 0 01-5.7 3.3c-.927 0-1.82-.187-2.65-.544l-.23-.09A7.001 7.001 0 014.93 12z"/></svg>
          Wechselrichter
        </h2>
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold text-gray-700">Wechselrichter</h3>
            <button type="button" id="addInverterButton" class="text-sm text-green-600 hover:text-green-800 transition-colors">+ weiterer Wechselrichter</button>
        </div>
        <div id="inverterItems" class="space-y-3"></div>
        <div class="mt-4 grid md:grid-cols-4 gap-4">
          <div>
            <label for="inverterShipmentType" class="block text-sm font-medium text-gray-700">Art der Sendung</label>
            <select id="inverterShipmentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
              <option value="package">Paket</option>
              <option value="pallet">Europalette</option>
            </select>
          </div>
          <div>
            <label for="inverterTransportCount" class="block text-sm font-medium text-gray-700">Menge (Transport)</label>
            <input type="number" id="inverterTransportCount" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label for="inverterTransportPrice" class="block text-sm font-medium text-gray-700">Preis/Einheit (€)</label>
            <input type="number" id="inverterTransportPrice" value="0" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Transport Gesamt (€)</label>
            <input type="text" id="inverterTransportTotalDisplay" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 text-right num" readonly />
          </div>
        </div>
        <div class="mt-4 pt-4 border-t-2 border-slate-300 grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-3 text-right font-bold text-gray-700 text-lg pr-2">Zwischensumme Wechselrichter</div>
            <div>
                <input type="text" id="subtotalInverter" class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-slate-200 font-bold text-right num" value="0.00" readonly />
            </div>
        </div>
      </section>

      <!-- Battery Section -->
      <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 3.363-2.73 6.093-6.093 6.093h-.758v1.365c0 1.258-.87 2.308-2.008 2.531a2.383 2.383 0 01-2.083-2.327l.006-.173V12.75H4.125c-3.363 0-6.093-2.73-6.093-6.093S.762.282 4.125.282h12.031c3.363 0 6.093 2.73 6.093 6.093zm-5.625 2.25v-3.75h-8.25v3.75h8.25z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12.375 14.25v-1.5h-1.5v1.5h1.5z" transform="rotate(90 12.375 14.25)"/></svg>
          Speicher (Optional)
        </h2>

        <!-- Batteries: dynamic list -->
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">Batteriemodule</h3>
          <button type="button" id="addBatteryButton" class="text-sm text-green-600 hover:text-green-800 transition-colors">+ weiteres Batteriemodul</button>
        </div>
        <div id="batteryItems" class="space-y-3"></div>

        <!-- BMS: dynamic list -->
        <div class="flex items-center justify-between mt-6 mb-2">
          <h3 class="text-lg font-semibold text-gray-700">BMS / Steuermodul(e)</h3>
          <button type="button" id="addBmsButton" class="text-sm text-green-600 hover:text-green-800 transition-colors">+ weiteres BMS</button>
        </div>
        <div id="bmsItems" class="space-y-3"></div>

        <!-- Transport -->
        <div class="mt-6 grid md:grid-cols-4 gap-4">
          <div>
            <label for="batteryShipmentType" class="block text-sm font-medium text-gray-700">Art der Sendung</label>
            <select id="batteryShipmentType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
              <option value="package">Paket</option>
              <option value="pallet">Europalette</option>
            </select>
          </div>
          <div>
            <label for="batteryTransportCount" class="block text-sm font-medium text-gray-700">Menge (Transport)</label>
            <input type="number" id="batteryTransportCount" value="0" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label for="batteryTransportPrice" class="block text-sm font-medium text-gray-700">Preis/Einheit (€)</label>
            <input type="number" id="batteryTransportPrice" value="0" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Transport Gesamt (€)</label>
            <input type="text" id="batteryTransportTotalDisplay" value="0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 text-right num" readonly />
          </div>
        </div>
        <div class="mt-6 pt-4 border-t-2 border-slate-300 grid md:grid-cols-4 gap-4 items-center">
            <div class="md:col-span-3 text-right font-bold text-gray-700 text-lg pr-2">Zwischensumme Speicher</div>
            <div>
                <input type="text" id="subtotalStorage" class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-slate-200 font-bold text-right num" value="0.00" readonly />
            </div>
        </div>
      </section>

      <!-- Other Costs Section -->
      <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
          Verschiedene Kosten
        </h2>
        <div class="space-y-4">
            <div class="grid md:grid-cols-2 gap-4 border-b border-slate-200 pb-4">
              <div>
                <label for="constructionCost" class="block text-sm font-medium text-gray-700">Unterkonstruktion (€/Wp)</label>
                <input type="number" id="constructionCost" value="0.15" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
              </div>
              <div>
                <label for="constructionTotalDisplay" class="block text-sm font-medium text-gray-700">Gesamtkosten Unterkonstruktion (€)</label>
                <input type="text" id="constructionTotalDisplay" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 font-bold text-right num" value="0.00" readonly />
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-4 border-b border-slate-200 pb-4">
                <div>
                    <label for="accessoriesCost" class="block text-sm font-medium text-gray-700">Montagekosten (€/Wp)</label>
                    <input type="number" id="accessoriesCost" value="0.05" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
                </div>
                <div>
                    <label for="accessoriesTotalDisplay" class="block text-sm font-medium text-gray-700">Gesamtkosten Montage (€)</label>
                    <input type="text" id="accessoriesTotalDisplay" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 font-bold text-right num" value="0.00" readonly />
                </div>
            </div>
        </div>
        <div class="mt-6 space-y-4">
          <h3 class="text-xl font-semibold text-gray-700">Zusätzliche Kosten</h3>
          <div id="additionalCostsContainer"></div>
          <button type="button" id="addCostButton" class="text-sm text-green-600 hover:text-green-800 transition-colors">+ Weiteren Kostenpunkt hinzufügen</button>
        </div>
        <div class="mt-6 pt-4 border-t-2 border-slate-300 grid md:grid-cols-2 gap-4 items-center">
            <label class="block text-lg font-bold text-gray-700 text-right">Zwischensumme Verschiedene Kosten</label>
            <input type="text" id="subtotalMisc" class="block w-full rounded-md border-gray-300 shadow-sm p-2 bg-slate-200 font-bold text-right num" value="0.00" readonly />
        </div>
      </section>

      <!-- Final Price Calculation Method -->
      <section class="bg-slate-50 p-6 rounded-xl border border-slate-200">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 110-18 9 9 0 010 18z"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 12c.966 0 1.905.212 2.753.627A5.992 5.992 0 0012 17.5a5.992 5.992 0 00-2.753-4.873A3.001 3.001 0 0112 12z"/></svg>
          Endpreis-Berechnung
        </h2>
        <div class="flex items-center space-x-4 mb-4">
          <div class="flex items-center">
            <input type="radio" id="useProfitMargin" name="calculationMethod" value="profit" checked class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500" />
            <label for="useProfitMargin" class="ml-2 block text-sm font-medium text-gray-700">Gewinnspanne</label>
          </div>
          <div class="flex items-center">
            <input type="radio" id="useFixedPrice" name="calculationMethod" value="fixed" class="h-4 w-4 text-green-600 border-gray-300 focus:ring-green-500" />
            <label for="useFixedPrice" class="ml-2 block text-sm font-medium text-gray-700">Festpreis pro kWp</label>
          </div>
        </div>
        <div id="profitMarginDiv">
          <label for="profitMargin" class="block text-sm font-medium text-gray-700">Gewünschte Gewinnspanne (%)</label>
          <input type="number" id="profitMargin" value="20" min="0" step="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
        </div>
        <div id="fixedPriceDiv" class="hidden">
          <label for="fixedPricePerKwp" class="block text-sm font-medium text-gray-700">Festpreis (€/kWp)</label>
          <input type="number" id="fixedPricePerKwp" value="1300" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" />
        </div>
      </section>

      <div class="flex justify-center">
        <button type="button" id="calculateButton" class="w-full md:w-auto px-8 py-4 bg-green-600 text-white rounded-xl shadow-lg hover:bg-green-700 transition-colors font-bold text-lg">Kosten berechnen</button>
      </div>
    </form>

    <!-- Results Section -->
    <section id="results" class="mt-10 hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Kostenaufstellung</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden shadow-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Komponente</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gesamtkosten (€)</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Kosten pro Wp (€/Wp)</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Gesamtanlagenleistung</td>
              <td id="result-totalPower" colspan="2" class="px-6 py-4 text-right whitespace-nowrap text-sm text-gray-500">0 Wp</td>
            </tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900">Module (Materialien)</td><td id="result-panelsCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td><td id="result-panelsCostPerWp" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900">Wechselrichter (Materialien)</td><td id="result-inverterCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td><td id="result-inverterCostPerWp" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900">Batteriemodule & BMS</td><td id="result-batteryCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td><td id="result-batteryCostPerWp" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900">Unterkonstruktion</td><td id="result-constructionTotalCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td><td id="result-constructionUnitCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900">Montagekosten</td><td id="result-accessoriesTotalCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td><td id="result-accessoriesUnitCost" class="px-6 py-4 text-right text-sm text-gray-500">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm font-bold text-gray-900">Zusätzliche Kosten</td><td id="result-additionalCostsTotal" class="px-6 py-4 text-right font-bold text-sm text-gray-500">0.00</td><td id="result-additionalCostsPerWp" class="px-6 py-4 text-right font-bold text-sm text-gray-500">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900 font-bold">Transport Module</td><td id="result-panelTransportTotal" class="px-6 py-4 text-right text-sm text-gray-500 font-bold">0.00</td><td id="result-panelTransportUnitCost" class="px-6 py-4 text-right text-sm text-gray-500 font-bold">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900 font-bold">Transport Wechselrichter</td><td id="result-inverterTransportTotal" class="px-6 py-4 text-right text-sm text-gray-500 font-bold">0.00</td><td id="result-inverterTransportUnitCost" class="px-6 py-4 text-right text-sm text-gray-500 font-bold">0.00</td></tr>
            <tr><td class="px-6 py-4 text-sm text-gray-900 font-bold">Transport Speicher</td><td id="result-batteryTransportTotal" class="px-6 py-4 text-right text-sm text-gray-500 font-bold">0.00</td><td id="result-batteryTransportUnitCost" class="px-6 py-4 text-right text-sm text-gray-500 font-bold">0.00</td></tr>
            <tr class="bg-gray-100 font-bold"><td class="px-6 py-4 text-base text-gray-900">GESAMTE EPC-KOSTEN</td><td id="result-totalEPCCost" class="px-6 py-4 text-right text-base text-gray-900">0.00</td><td id="result-totalEPCCostPerWp" class="px-6 py-4 text-right text-base text-gray-900">0.00</td></tr>
            <tr class="bg-green-100 font-bold text-green-800 text-lg"><td class="px-6 py-4">ENDPREIS FÜR KUNDEN</td><td id="result-finalClientPrice" colspan="2" class="px-6 py-4 text-right">0.00</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Helpers ---
      const el = id => document.getElementById(id);
      const qs = (sel, root=document) => root.querySelector(sel);
      const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
      const numVal = input => parseFloat(input?.value) || 0;
      const setText = (id, val) => { const e = el(id); if (e) e.innerText = val; };
      const safeDiv = (a,b) => (b>0? (a/b).toFixed(2) : '0.00');

      const updateRowTotalByInputs = (countInput, priceInput, totalInput) => {
        const total = (numVal(countInput) * numVal(priceInput)).toFixed(2);
        totalInput.value = total;
      };
      
      const updateRowTotalByIds = (countId, priceId, totalId) => {
        const count = numVal(el(countId));
        const price = numVal(el(priceId));
        el(totalId).value = (count * price).toFixed(2);
      };

      const updateTransportTotal = (countId, priceId, totalDisplayId) => {
        const count = parseFloat(el(countId).value) || 0;
        const price = parseFloat(el(priceId).value) || 0;
        el(totalDisplayId).value = (count * price).toFixed(2);
      };
      
      const updatePriceFromSelect = (selectId, priceInputId, fallback) => {
        const s = el(selectId); const p = el(priceInputId); if (!s || !p) return;
        const opt = s.options[s.selectedIndex];
        const price = opt?.dataset?.price ? parseFloat(opt.dataset.price) : fallback;
        p.value = (price || 0).toFixed(2);
      };

      // --- Dynamic Inverters, Batteries & BMS ---
      const inverterOptionsHtml = `
        <option value="10000" data-price="1238.78">SUN2000-10K-MAP0 (10kW, hybrid, 3-phasig) - 1238,78 €</option>
        <option value="10000" data-price="1174.00">SUN2000-10KTL-LC0 (10kW, hybrid, 1-phasig) - 1174,00 €</option>
        <option value="10000" data-price="849.48" selected>SUN2000-10KTL-M1-HC (10kW, hybrid, 3-phasig, high-current) - 849,48 €</option>
        <option value="12000" data-price="1337.87">SUN2000-12K-MAP0 (12kW, hybrid, 3-phasig) - 1337,87 €</option>
        <option value="12000" data-price="815.62">SUN2000-12KTL-M5 (12kW, on-grid, 3-phasig) - 815,62 €</option>
        <option value="15000" data-price="984.37">SUN2000-15KTL-M5 (15kW, on-grid, 3-phasig) - 984,37 €</option>
        <option value="17000" data-price="1857.88">HUAWEI SUN2000-17K-MB0 (17 kW, hybrid, 3-phasig) - 1.857,88 €</option>
        <option value="17000" data-price="659.89">HUAWEI SUN2000-17KTL-M2-HC (17 kW, on-grid, 3-phasig) - 659,89 €</option>
        <option value="17000" data-price="1015.62">HUAWEI SUN2000-17KTL-M5 (17 kW, on-grid, 3-phasig) - 1.015,62 €</option>
        <option value="17000" data-price="1788.00">HUAWEI SUN2000-17KTL-M2 (17 kW, on-grid, 3-phasig) - 1.788,00 €</option>
        <option value="185000" data-price="4351.31">HUAWEI SUN2000-185KTL-H1 (185 kW, on-grid, 3-phasig) - 4.351,31 €</option>
        <option value="215000" data-price="5417.89">HUAWEI SUN2000-215KTL-H0 (215 kW, on-grid, 3-phasig) - 5.417,89 €</option>
        <option value="30000" data-price="1874.00">HUAWEI SUN2000-30KTL-M3 (30 kW, on-grid, 3-phasig) - 1.874,00 €</option>
        <option value="330000" data-price="7383.20">HUAWEI SUN2000-330KTL-H1 (330 kW, on-grid, 3-phasig) - 7.383,20 €</option>
        <option value="36000" data-price="2139.00">HUAWEI SUN2000-36KTL-M3 (36 kW, on-grid, 3-phasig) - 2.139,00 €</option>
        <option value="40000" data-price="2255.00">HUAWEI SUN2000-40KTL-M3 (40 kW, on-grid, 3-phasig) - 2.255,00 €</option>
        <option value="50000" data-price="2311.58">HUAWEI SUN2000-50KTL-M3 (50 kW, on-grid, 3-phasig) - 2.311,58 €</option>
        <option value="100000" data-price="3704.35">HUAWEI SUN2000-100KTL-M2 (100 kW, on-grid, 3-phasig) - 3.704,35 €</option>
        <option value="115000" data-price="3712.85">HUAWEI SUN2000-115KTL-M2 (115 kW, on-grid, 3-phasig) - 3.712,85 €</option>
        <option value="8000" data-price="719.99">SUN2000-8KTL-M1-HC (8kW, hybrid, 3-phasig, high-current) - 719,99 €</option>
        <option value="1" data-price="265.58">EMMA-A02 (Energy Management Assistant) - 265,58 €</option>
      `;

      const batteryOptionsHtml = `
        <option value="5000" data-price="1598.00">Huawei LUNA2000-5-E0 (Batteriemodul 5kWh) - 1598,00 €</option>
        <option value="7000" data-price="2229.00">Huawei LUNA2000-7-E1 (Batteriemodul 6,9KWh) - 2229,00 €</option>
        <option value="5000" data-price="2197.00" data-is-set="true">SET LUNA2000-5KW-C0/LUNA2000-5-E0 (Steuermodul + 1) - 2197,00 €</option>
        <option value="10000" data-price="3767.00" data-is-set="true">SET LUNA2000-5KW-C0/LUNA2000-5-E0/LUNA2000-5-E0 (Steuermodul + 2) - 3767,00 €</option>
        <option value="15000" data-price="5337.00" data-is-set="true">SET LUNA2000-5KW-C0/LUNA2000-5-E0/LUNA2000-5-E0/LUNA2000-5-E0 (Steuermodul + 3) - 5337,00 €</option>`;

      const bmsOptionsHtml = `
        <option value="0" data-price="0">Kein BMS</option>
        <option value="10000" data-price="799.00">Huawei LUNA2000-10KW-C1 (10 kW Steuermodul) - 799,00 €</option>
        <option value="5000" data-price="629.00" selected>Huawei LUNA2000-5KW-C0 (5 kW Steuermodul) - 629,00 €</option>`;

      const addInverterRow = () => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-4 inverter-row items-end pb-2';
        row.innerHTML = `
          <div class="col-span-11 grid md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Modell</label>
              <select class="inverter-model mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">${inverterOptionsHtml}</select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Anzahl</label>
              <input type="number" class="inverter-count mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" value="1" min="0" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Kosten pro Einheit (€)</label>
              <input type="number" class="inverter-price mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" value="849.48" min="0" step="0.01" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Gesamtkosten (€)</label>
              <input type="text" class="inverter-total mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 text-right num" value="0.00" readonly />
            </div>
          </div>
          <div class="col-span-1 flex items-center justify-center">
             <button type="button" class="delete-row-btn p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
          </div>
          `;
        el('inverterItems').appendChild(row);
        const sel = row.querySelector('.inverter-model');
        const priceInput = row.querySelector('.inverter-price');
        const opt = sel.options[sel.selectedIndex];
        priceInput.value = (opt?.dataset?.price ? parseFloat(opt.dataset.price) : 0).toFixed(2);
        updateRowTotalByInputs(qs('.inverter-count', row), priceInput, qs('.inverter-total', row));
      };

      const addBatteryRow = () => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-4 battery-row items-end pb-2';
        row.innerHTML = `
          <div class="col-span-11 grid md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Modell</label>
              <select class="battery-model mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">${batteryOptionsHtml}</select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Anzahl</label>
              <input type="number" class="battery-count mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" value="0" min="0" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Kosten pro Einheit (€)</label>
              <input type="number" class="battery-price mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" value="1598.00" min="0" step="0.01" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Gesamtkosten (€)</label>
              <input type="text" class="battery-total mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 text-right num" value="0.00" readonly />
            </div>
          </div>
          <div class="col-span-1 flex items-center justify-center">
             <button type="button" class="delete-row-btn p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
          </div>`;
        el('batteryItems').appendChild(row);
        const sel = row.querySelector('.battery-model');
        const priceInput = row.querySelector('.battery-price');
        const opt = sel.options[sel.selectedIndex];
        priceInput.value = (opt?.dataset?.price ? parseFloat(opt.dataset.price) : 0).toFixed(2);
      };

      const addBmsRow = () => {
        const row = document.createElement('div');
        row.className = 'grid grid-cols-12 gap-4 bms-row items-end pb-2';
        row.innerHTML = `
          <div class="col-span-11 grid md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">BMS-Modell</label>
              <select class="bms-model mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">${bmsOptionsHtml}</select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Menge</label>
              <input type="number" class="bms-count mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" value="0" min="0" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">BMS-Preis (€)</label>
              <input type="number" class="bms-price mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-green-500 focus:border-green-500 p-2" value="629.00" min="0" step="0.01" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Gesamtkosten (€)</label>
              <input type="text" class="bms-total mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100 text-right num" value="0.00" readonly />
            </div>
          </div>
          <div class="col-span-1 flex items-center justify-center">
             <button type="button" class="delete-row-btn p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
          </div>`;
        el('bmsItems').appendChild(row);
        const sel = row.querySelector('.bms-model');
        const priceInput = row.querySelector('.bms-price');
        const opt = sel.options[sel.selectedIndex];
        priceInput.value = (opt?.dataset?.price ? parseFloat(opt.dataset.price) : 0).toFixed(2);
      };

      const addAdditionalCostField = () => {
        const container = el('additionalCostsContainer');
        const index = container.children.length; if (index >= 10) return;
        const div = document.createElement('div');
        div.className = 'grid grid-cols-12 gap-4 additional-cost-row items-end pb-2 border-t border-slate-200 pt-4';
        div.innerHTML = `
          <div class="col-span-11 grid md:grid-cols-4 gap-2">
            <div>
              <label for="addCostDesc_${index}" class="block text-sm font-medium text-gray-700">Beschreibung</label>
              <input type="text" id="addCostDesc_${index}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="z.B. Überwachung" />
            </div>
            <div>
              <label for="addCostType_${index}" class="block text-sm font-medium text-gray-700">Kostenart</label>
              <select id="addCostType_${index}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                <option value="perWp">pro Wp (€)</option>
                <option value="perPiece">pro Stück (€)</option>
              </select>
            </div>
            <div>
              <label for="addCostQty_${index}" class="block text-sm font-medium text-gray-700">Menge</label>
              <input type="number" id="addCostQty_${index}" value="1" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
            </div>
            <div>
              <label for="addCostPrice_${index}" class="block text-sm font-medium text-gray-700">Preis</label>
              <input type="number" id="addCostPrice_${index}" value="0" min="0" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" />
            </div>
          </div>
          <div class="col-span-1 flex items-center justify-center">
             <button type="button" class="delete-row-btn p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-md transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
          </div>`;
        container.appendChild(div);
        qsa('.additional-cost-row input, .additional-cost-row select').forEach(input => {
            input.addEventListener('input', updateAllSubtotals);
        });
      };
      
      const getAdditionalCostsTotal = () => {
        let total = 0;
        const container = el('additionalCostsContainer');
        const panelModel = parseFloat(el('panelModel').value) || 0;
        const panelCount = parseFloat(el('panelCount').value) || 0;
        const totalPowerWp = panelCount * panelModel;
        
        qsa('.additional-cost-row').forEach((row, index) => {
            const type = qs(`#addCostType_${index}`)?.value;
            const qty  = numVal(qs(`#addCostQty_${index}`));
            const price= numVal(qs(`#addCostPrice_${index}`));
            if (type === 'perWp') {
                total += price * totalPowerWp;
            } else {
                total += qty * price;
            }
        });
        return total;
      };

      const updateAllSubtotals = () => {
        // Panel Subtotal
        const panelTotal = numVal(el('panelRowTotal'));
        const panelTransport = numVal(el('panelTransportTotalDisplay'));
        el('subtotalPanels').value = (panelTotal + panelTransport).toFixed(2);

        // Inverter Subtotal
        let inverterMaterialTotal = 0;
        qsa('.inverter-row').forEach(row => {
            inverterMaterialTotal += numVal(qs('.inverter-total', row));
        });
        const inverterTransport = numVal(el('inverterTransportTotalDisplay'));
        el('subtotalInverter').value = (inverterMaterialTotal + inverterTransport).toFixed(2);

        // Storage Subtotal
        let batteryTotal = 0;
        qsa('.battery-total').forEach(inp => batteryTotal += numVal(inp));
        let bmsTotal = 0;
        qsa('.bms-total').forEach(inp => bmsTotal += numVal(inp));
        const batteryTransport = numVal(el('batteryTransportTotalDisplay'));
        el('subtotalStorage').value = (batteryTotal + bmsTotal + batteryTransport).toFixed(2);

        // Misc Costs Subtotal
        const constructionTotal = numVal(el('constructionTotalDisplay'));
        const accessoriesTotal = numVal(el('accessoriesTotalDisplay'));
        const additionalCostsTotal = getAdditionalCostsTotal();
        el('subtotalMisc').value = (constructionTotal + accessoriesTotal + additionalCostsTotal).toFixed(2);
      };

      const updateWpBasedTotals = () => {
        const panelModel = parseFloat(el('panelModel').value) || 0;
        const panelCount = parseFloat(el('panelCount').value) || 0;
        const totalPowerWp = panelCount * panelModel;
        const constructionCostPerWp = numVal(el('constructionCost'));
        el('constructionTotalDisplay').value = (totalPowerWp * constructionCostPerWp).toFixed(2);
        const accessoriesCostPerWp = numVal(el('accessoriesCost'));
        el('accessoriesTotalDisplay').value = (totalPowerWp * accessoriesCostPerWp).toFixed(2);
      };

      const calculateCosts = () => {
        const panelModel = parseFloat(el('panelModel').value) || 0;
        const panelCount = parseFloat(el('panelCount').value) || 0;
        const panelPrice = parseFloat(el('panelPrice').value) || 0;
        const panelTransportTotal = numVal(el('panelTransportTotalDisplay'));
        
        let inverterTotalCost = 0;
        qsa('.inverter-row').forEach(row => {
          inverterTotalCost += numVal(qs('.inverter-total', row));
        });
        const inverterTransportTotal = numVal(el('inverterTransportTotalDisplay'));

        let batteriesTotalCost = 0;
        qsa('.battery-row').forEach(row => {
          batteriesTotalCost += numVal(qs('.battery-total', row));
        });
        let bmsTotalCost = 0;
        qsa('.bms-row').forEach(row => {
          bmsTotalCost += numVal(qs('.bms-total', row));
        });
        const batteryTransportTotal = numVal(el('batteryTransportTotalDisplay'));
        const constructionCostPerWp = parseFloat(el('constructionCost').value) || 0;
        const accessoriesCostPerWp = parseFloat(el('accessoriesCost').value) || 0;
        const totalPowerWp = panelCount * panelModel;
        const totalPowerKwp = totalPowerWp / 1000;
        const panelsTotalCost = panelCount * panelPrice;
        const batteryTotalCost = batteriesTotalCost + bmsTotalCost;
        const constructionTotalCost = totalPowerWp * constructionCostPerWp;
        const accessoriesTotalCost = totalPowerWp * accessoriesCostPerWp;
        const additionalCosts = getAdditionalCostsTotal();
        const transportTotalCost = panelTransportTotal + inverterTransportTotal + batteryTransportTotal;
        const totalEPCCost = panelsTotalCost + inverterTotalCost + batteryTotalCost +
          constructionTotalCost + accessoriesTotalCost + additionalCosts + transportTotalCost;
        let finalClientPrice = 0;
        if (el('useProfitMargin').checked) {
          const pm = (parseFloat(el('profitMargin').value) || 0) / 100;
          finalClientPrice = totalEPCCost * (1 + pm);
        } else if (el('useFixedPrice').checked) {
          const fx = parseFloat(el('fixedPricePerKwp').value) || 0;
          finalClientPrice = totalPowerKwp * fx;
        }
        setText('result-totalPower', `${totalPowerWp} Wp (${totalPowerKwp.toFixed(2)} kWp)`);
        setText('result-panelsCost', panelsTotalCost.toFixed(2));
        setText('result-panelsCostPerWp', safeDiv(panelsTotalCost, totalPowerWp));
        setText('result-inverterCost', inverterTotalCost.toFixed(2));
        setText('result-inverterCostPerWp', safeDiv(inverterTotalCost, totalPowerWp));
        setText('result-batteryCost', batteryTotalCost.toFixed(2));
        setText('result-batteryCostPerWp', safeDiv(batteryTotalCost, totalPowerWp));
        setText('result-constructionTotalCost', constructionTotalCost.toFixed(2));
        setText('result-constructionUnitCost', constructionCostPerWp.toFixed(2));
        setText('result-accessoriesTotalCost', accessoriesTotalCost.toFixed(2));
        setText('result-accessoriesUnitCost', accessoriesCostPerWp.toFixed(2));
        setText('result-additionalCostsTotal', additionalCosts.toFixed(2));
        setText('result-additionalCostsPerWp', safeDiv(additionalCosts, totalPowerWp));
        setText('result-panelTransportTotal', panelTransportTotal.toFixed(2));
        setText('result-panelTransportUnitCost', safeDiv(panelTransportTotal, totalPowerWp));
        setText('result-inverterTransportTotal', inverterTransportTotal.toFixed(2));
        setText('result-inverterTransportUnitCost', safeDiv(inverterTransportTotal, totalPowerWp));
        setText('result-batteryTransportTotal', batteryTransportTotal.toFixed(2));
        setText('result-batteryTransportUnitCost', safeDiv(batteryTransportTotal, totalPowerWp));
        setText('result-totalEPCCost', totalEPCCost.toFixed(2));
        setText('result-totalEPCCostPerWp', safeDiv(totalEPCCost, totalPowerWp));
        setText('result-finalClientPrice', finalClientPrice.toFixed(2));
        el('results').classList.remove('hidden');
      };

      // --- Event Listeners ---
      // Panels
      el('panelModel').addEventListener('change', () => { 
          updatePriceFromSelect('panelModel','panelPrice', 46.99); 
          updateRowTotalByIds('panelCount','panelPrice','panelRowTotal');
          updateWpBasedTotals();
          updateAllSubtotals();
      });
      el('panelCount').addEventListener('input', () => {
          updateRowTotalByIds('panelCount','panelPrice','panelRowTotal');
          updateWpBasedTotals();
          updateAllSubtotals();
      });
      el('panelPrice').addEventListener('input', () => {
          updateRowTotalByIds('panelCount','panelPrice','panelRowTotal');
          updateAllSubtotals();
      });
      ['panelTransportCount','panelTransportPrice'].forEach(id => el(id)?.addEventListener('input', () => {
          updateTransportTotal('panelTransportCount','panelTransportPrice','panelTransportTotalDisplay');
          updateAllSubtotals();
      }));

      // Dynamic Inverters
      el('inverterItems').addEventListener('click', (e) => {
        if (e.target.closest('.delete-row-btn')) {
            e.target.closest('.inverter-row').remove();
            updateAllSubtotals();
        }
      });
      el('inverterItems').addEventListener('change', (e) => {
          if (e.target.classList.contains('inverter-model')) {
              const row = e.target.closest('.inverter-row');
              const opt = e.target.options[e.target.selectedIndex];
              qs('.inverter-price', row).value = (opt?.dataset?.price ? parseFloat(opt.dataset.price) : 0).toFixed(2);
              updateRowTotalByInputs(qs('.inverter-count', row), qs('.inverter-price', row), qs('.inverter-total', row));
              updateAllSubtotals();
          }
      });
      el('inverterItems').addEventListener('input', (e) => {
          if (e.target.classList.contains('inverter-count') || e.target.classList.contains('inverter-price')) {
              const row = e.target.closest('.inverter-row');
              updateRowTotalByInputs(qs('.inverter-count', row), qs('.inverter-price', row), qs('.inverter-total', row));
              updateAllSubtotals();
          }
      });
      ['inverterTransportCount','inverterTransportPrice'].forEach(id => el(id)?.addEventListener('input', () => {
          updateTransportTotal('inverterTransportCount','inverterTransportPrice','inverterTransportTotalDisplay');
          updateAllSubtotals();
      }));

      // Battery transport
      ['batteryTransportCount','batteryTransportPrice'].forEach(id => el(id)?.addEventListener('input', () => {
          updateTransportTotal('batteryTransportCount','batteryTransportPrice','batteryTransportTotalDisplay');
          updateAllSubtotals();
      }));

      // Wp-based costs listeners
      el('constructionCost').addEventListener('input', () => {
          updateWpBasedTotals();
          updateAllSubtotals();
      });
      el('accessoriesCost').addEventListener('input', () => {
          updateWpBasedTotals();
          updateAllSubtotals();
      });

      // Dynamic Rows
      el('batteryItems').addEventListener('click', (e) => {
        if (e.target.closest('.delete-row-btn')) {
            e.target.closest('.battery-row').remove();
            updateAllSubtotals();
        }
      });
      el('batteryItems').addEventListener('change', (e) => {
          if (e.target.classList.contains('battery-model')) {
              const row = e.target.closest('.battery-row');
              const opt = e.target.options[e.target.selectedIndex];
              qs('.battery-price', row).value = (opt?.dataset?.price ? parseFloat(opt.dataset.price) : 0).toFixed(2);
              updateRowTotalByInputs(qs('.battery-count', row), qs('.battery-price', row), qs('.battery-total', row));
              updateAllSubtotals();
          }
      });
      el('batteryItems').addEventListener('input', (e) => {
          if (e.target.classList.contains('battery-count') || e.target.classList.contains('battery-price')) {
              const row = e.target.closest('.battery-row');
              updateRowTotalByInputs(qs('.battery-count', row), qs('.battery-price', row), qs('.battery-total', row));
              updateAllSubtotals();
          }
      });
       el('bmsItems').addEventListener('click', (e) => {
        if (e.target.closest('.delete-row-btn')) {
            e.target.closest('.bms-row').remove();
            updateAllSubtotals();
        }
      });
       el('bmsItems').addEventListener('change', (e) => {
          if (e.target.classList.contains('bms-model')) {
              const row = e.target.closest('.bms-row');
              const opt = e.target.options[e.target.selectedIndex];
              qs('.bms-price', row).value = (opt?.dataset?.price ? parseFloat(opt.dataset.price) : 0).toFixed(2);
              updateRowTotalByInputs(qs('.bms-count', row), qs('.bms-price', row), qs('.bms-total', row));
              updateAllSubtotals();
          }
      });
      el('bmsItems').addEventListener('input', (e) => {
          if (e.target.classList.contains('bms-count') || e.target.classList.contains('bms-price')) {
              const row = e.target.closest('.bms-row');
              updateRowTotalByInputs(qs('.bms-count', row), qs('.bms-price', row), qs('.bms-total', row));
              updateAllSubtotals();
          }
      });
      el('additionalCostsContainer').addEventListener('click', (e) => {
        if (e.target.closest('.delete-row-btn')) {
            e.target.closest('.additional-cost-row').remove();
            updateAllSubtotals();
        }
      });

      // Profit vs Fixed
      const profitRadio = el('useProfitMargin');
      const fixedRadio = el('useFixedPrice');
      const profitDiv = el('profitMarginDiv');
      const fixedDiv = el('fixedPriceDiv');
      const handleCalcMethodChange = () => {
          profitDiv.classList.toggle('hidden', !profitRadio.checked);
          fixedDiv.classList.toggle('hidden', !fixedRadio.checked);
      };
      profitRadio.addEventListener('change', handleCalcMethodChange);
      fixedRadio.addEventListener('change', handleCalcMethodChange);

      // Buttons
      el('calculateButton').addEventListener('click', calculateCosts);
      el('addInverterButton').addEventListener('click', addInverterRow);
      el('addCostButton').addEventListener('click', addAdditionalCostField);
      el('addBatteryButton').addEventListener('click', addBatteryRow);
      el('addBmsButton').addEventListener('click', addBmsRow);

      // --- Init ---
      addInverterRow();
      addBatteryRow();
      addBmsRow();
      addAdditionalCostField();
      updatePriceFromSelect('panelModel','panelPrice',46.99);
      updateRowTotalByIds('panelCount','panelPrice','panelRowTotal');
      updateWpBasedTotals();
      updateAllSubtotals();
    });
  </script>
</body>
</html>
